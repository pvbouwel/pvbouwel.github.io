<!doctype html><html lang=en><head><title>Custom routing for Linux process · Allinthemiddle</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="pvbouwel"><meta name=description content="
  Control network routes for specific processes on Linux
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

I wanted to control the flow of packets for specific processes on my Linux (Ubuntu 22.04) such that they won&rsquo;t go through a tunnel device which is setup for VPN connectivity. The VPN software is provided as is and I do not administer its configuration."><meta name=keywords content="blog,devops,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Custom routing for Linux process"><meta name=twitter:description content="Control network routes for specific processes on Linux Link to heading Intro Link to heading I wanted to control the flow of packets for specific processes on my Linux (Ubuntu 22.04) such that they won’t go through a tunnel device which is setup for VPN connectivity. The VPN software is provided as is and I do not administer its configuration."><meta property="og:url" content="http://pvbouwel.github.io/posts/custom-routing-for-linux-process/"><meta property="og:site_name" content="Allinthemiddle"><meta property="og:title" content="Custom routing for Linux process"><meta property="og:description" content="Control network routes for specific processes on Linux Link to heading Intro Link to heading I wanted to control the flow of packets for specific processes on my Linux (Ubuntu 22.04) such that they won’t go through a tunnel device which is setup for VPN connectivity. The VPN software is provided as is and I do not administer its configuration."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-07T14:57:49+02:00"><meta property="article:modified_time" content="2024-05-07T14:57:49+02:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Networking"><link rel=canonical href=http://pvbouwel.github.io/posts/custom-routing-for-linux-process/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.6445a802b9389c9660e1b07b724dcf5718b1065ed2d71b4eeaf981cc7cc5fc46.css integrity="sha256-ZEWoArk4nJZg4bB7ck3PVxixBl7S1xtO6vmBzHzF/EY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/img/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://pvbouwel.github.io/>Allinthemiddle
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://pvbouwel.github.io/posts/custom-routing-for-linux-process/>Custom routing for Linux process</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-05-07T14:57:49+02:00>May 7, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
6-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/linux/>Linux</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/networking/>Networking</a></span></div></div></header><div class=post-content><h1 id=control-network-routes-for-specific-processes-on-linux>Control network routes for specific processes on Linux
<a class=heading-link href=#control-network-routes-for-specific-processes-on-linux><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><h2 id=intro>Intro
<a class=heading-link href=#intro><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I wanted to control the flow of packets for specific processes on my Linux (Ubuntu 22.04) such that they won&rsquo;t go through a tunnel device which is setup for VPN connectivity. The VPN software is provided as is and I do not administer its configuration.</p><p>Please note that this post assumes you have understanding of network routing and are equiped to troubleshoot problems. If not you should first learn how networks work first. Each network setup has its own specifics. Appliance vendors come up with defaults and automation for the most common scenarios. Custom configuration can conflict with that and might isolate you from network access. All responsibilities remain those of the reader.</p><h3 id=what-worked>What worked
<a class=heading-link href=#what-worked><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><h4 id=summary-of-the-solution>Summary of the solution
<a class=heading-link href=#summary-of-the-solution><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>Use the network classifier cgroup (src: <a href=https://docs.kernel.org/admin-guide/cgroup-v1/net_cls.html class=external-link target=_blank rel=noopener>docs.kernel.org</a>) to tag network packets with a class identifier (classid) for a process and its subprocesses (src: <a href=https://unix.stackexchange.com/questions/743436/how-to-mark-packets-by-program class=external-link target=_blank rel=noopener>unix.stackexchange.com</a>). Subsequently use iptables to mark packets which you can use from a custom routing table using policy-based routing <a href=https://serverfault.com/questions/345111/iptables-target-to-route-packet-to-specific-interface class=external-link target=_blank rel=noopener>serverfault.com</a>.</p><h4 id=step-by-step-for-an-example-scenario>Step by step for an example scenario
<a class=heading-link href=#step-by-step-for-an-example-scenario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>Imagine that for certain tasks you need to use a VPN that is provided and configured by another team. The VPN software setups up a tunnel interface on your computer and configures a default route for this tunnel device. You still want to use a public service that provides a dedicated client but for which you don&rsquo;t want traffic to go over the VPN (e.g. an audio streaming service like Spotify).</p><p><strong>Step 1 : Create a novpn network class</strong></p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo mkdir /sys/fs/cgroup/net_cls
</span></span><span style=display:flex><span>sudo mount -t cgroup -onet_cls net_cls /sys/fs/cgroup/net_cls
</span></span><span style=display:flex><span>sudo mkdir /sys/fs/cgroup/net_cls/novpn
</span></span><span style=display:flex><span>echo 0x100001 | sudo tee /sys/fs/cgroup/net_cls/novpn/net_cls.classid
</span></span></code></pre></div><p>You can see the upstream documentation on <a href=https://docs.kernel.org/admin-guide/cgroup-v1/net_cls.html class=external-link target=_blank rel=noopener>https://docs.kernel.org/admin-guide/cgroup-v1/net_cls.html</a> . Important is the structure of the classid. You can freely chose it as long as it is unique for your system but if you chose another id make sure to check the id doing a cat on the file as it will be needed later:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat /sys/fs/cgroup/net_cls/novnp/net_cls.classid
</span></span><span style=display:flex><span><span style=color:#a5d6ff>1048577</span>
</span></span></code></pre></div><p><strong>Step 2 : Create custom routing table</strong></p><p>In order to create the custom routing table the easiest way is to just &lsquo;clone&rsquo; the default route from your setup when the VPN is not up. You can easily get this using ip:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ip route | grep default
</span></span><span style=display:flex><span>default via 192.168.0.1 dev wlp0s20f3 proto dhcp metric <span style=color:#a5d6ff>600</span> 
</span></span></code></pre></div><p>With that it is best to pick a route table number that is not in use such that there is a dedicated routing table. As per <a href=https://serverfault.com/questions/618857/list-all-route-tables class=external-link target=_blank rel=noopener>serverfault.com</a> this can be done using:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ip route show table all | grep -Po <span style=color:#a5d6ff>&#39;table \K[^\s]+&#39;</span> | sort -u
</span></span><span style=display:flex><span>local
</span></span></code></pre></div><p>The example output above would just mean there is no tables besides the reserved routing tables. In our case we want a dedicated route table for traffic that should not go through VPN so lets register it officially with a number not taken. I chose 3 and I can register it as follows::</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#a5d6ff>&#34;3\tnovpn&#34;</span>  | sudo tee -a /etc/iproute2/rt_tables
</span></span><span style=display:flex><span><span style=color:#a5d6ff>3</span>    novpn
</span></span></code></pre></div><p>For me this file looks now like:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat /etc/iproute2/rt_tables
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># reserved values</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>255</span>    local
</span></span><span style=display:flex><span><span style=color:#a5d6ff>254</span>    main
</span></span><span style=display:flex><span><span style=color:#a5d6ff>253</span>    default
</span></span><span style=display:flex><span><span style=color:#a5d6ff>0</span>    unspec
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># local</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#1    inr.ruhep</span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>3</span>    novpn
</span></span></code></pre></div><p>So it shows the reserved values as well as the table id we chose and its logical name &rsquo;novpn&rsquo;. We should also pick a firewall mark to mark the packets. We can check all the iptables tables for marks:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#ff7b72>for</span> table in raw security mangle nat filter; <span style=color:#ff7b72>do</span> echo <span style=color:#a5d6ff>&#34;===</span><span style=color:#79c0ff>$table</span><span style=color:#a5d6ff>===&#34;</span>;sudo /sbin/iptables -L -n --line-numbers --table <span style=color:#79c0ff>$table</span> -v; <span style=color:#ff7b72>done</span> | grep -o <span style=color:#a5d6ff>&#34;MARK set [0-9x]*&#34;</span> 
</span></span></code></pre></div><p>On my setup there were no firewall marks yet. I will therefore use mark 2 in this example. Now we have all the inputs to setup our route table</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ip rule add fwmark <span style=color:#a5d6ff>2</span> table <span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>ip route add default via 192.168.0.1 dev wlp0s20f3 proto dhcp metric <span style=color:#a5d6ff>1</span> table <span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>ip route flush cache
</span></span></code></pre></div><p>With the first command we make sure the routing table is selected for packets with firewall mark 2. With the second command we add the default route to our routing table. And finally we clear cache to make sure new config is used.</p><p><strong>Step 3 : Configure the marking using iptables</strong></p><p>Since we already decided upon the mark and we have setup the cgroup and know its class id we have everything to configure iptables to mark pakkets as desired:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo iptables -t mangle -A OUTPUT -m cgroup --cgroup <span style=color:#a5d6ff>1048577</span> -j MARK --set-mark <span style=color:#a5d6ff>2</span>
</span></span></code></pre></div><p><strong>Step 4: Start our process such that it has the cgroup class id</strong></p><p>It is important our processes get the cgroup class id. This can be done by registering their process ID in <code>/sys/fs/cgroup/net_cls/novpn/tasks</code>. This could become quite tedious since a lot of programs spawn a lot of children. Luckily Linux keeps track of the parent child hierarchy and if we register a process all its children will also be added. So if you spawn a terminal window and register its pid and subsequently spawn the process than the process and all of its children will get associated with this novpn cgroup class.</p><pre tabindex=0><code>echo $$ | sudo tee /sys/fs/cgroup/net_cls/novpn/tasks
spotify
</code></pre><p>Now this Spotify process will have all its packets adhere to routing table 3 which doesn&rsquo;t have a route for the VPN but rather goes as if there wasn&rsquo;t a VPN setup.</p><h2 id=final-notes>Final notes
<a class=heading-link href=#final-notes><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>I do not represent Spotify I just use their services and it felt to be a useful example (their client application spawns multiple processes and needs to be able to communicate with other OS entities which makes other solutions like using netns more tricky).</li><li>When using the terminal approach, one should take care not to use the terminal for actions that require VPN connectivity as per-design those wouldn&rsquo;t work in that terminal.</li><li>This is a rather static solution if you move your computer and end up on a new network then likely you need a different network configuration (other default route in the custom table)</li><li>Verify the marking of packets of a cgroup is working. An easy trick to verify the tagging is working is by changing the iptables rule to drop the - packages rather than to mark them. Then you can easily verify that Spotify works when launched outside the &ldquo;novpn&rdquo; terminal but that it cannot connect to any network when launched inside the &ldquo;novpn&rdquo; terminal.</li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2009 -
2025
pvbouwel
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>